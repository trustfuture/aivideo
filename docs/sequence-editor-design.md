# 序列编辑器（Sequence Editor）设计方案 v1

本文档描述将 Shotlist 与 时间线融合为统一“序列编辑器（Sequence Editor）”的产品与技术方案（方案 A），聚焦信息架构、交互、数据接口与迭代计划。此方案待产品方授权后实施。

## 摘要
- 当前 Shotlist（结构化文本/参数）与 时间线（时序/节奏）割裂，心智负担高。
- 目标：统一为“每个分镜的一组参数 + 画面时序 + AI 操作”的单一心智模型。
- 产出：一个混合视图（时间线 + 列表联动）+ 右侧全局面板 + 行内抽屉编辑。
- 引入“分镜级字幕（v1：时移/样式覆盖；v2：AI 重写）”。

## 设计原则
- 单一数据源：segments（每段=一个分镜/片段）。所有视图均是该数据的不同呈现。
- 渐进增强：先落地必需操作（M1），再逐步注入 AI 能力（M2/M3）。
- 快速反馈：预览不混音/字幕，保证速度；全量渲染再叠加音视频与字幕。
- 可回退：自动保存 + 撤销/重做；批量操作可撤销。

## 信息架构（IA）与布局（方案 A：分屏混合视图）

- 顶部工具栏：视图切换、AI 建议、预览/渲染、保存等主操作。
- 中部“时间线”：拖拽排序、修剪、缩放、选中多段；展示总时长与音频参照线。
- 下部“列表”：与时间线联动，行内编辑核心参数；支持批量选择与操作。
- 行内“抽屉”：展开编辑该分镜的详细参数与 AI 操作（字幕/文案/转场建议等）。
- 右侧“全局面板”：全局字幕样式/偏移、BGM 音量与淡入淡出、Duck 等。

```
+----------------------------------------------------------------------------------+
| Toolbar: [视图: 列表 | 时间线 | 混合]  [AI建议] [预览N段▼] [全量渲染] [保存]         |
+----------------------------------------------------------------------------------+
| 时间线（拖拽排序、两端修剪、缩放、选中高亮，多选批量操作）                        |
| [seg1][seg2]...[segN]   —— 时码标尺 ——   音频总时长指示                           |
+----------------------------------------------------------------------------------+
| 列表（与时间线联动，支持行内编辑与抽屉展开）                                     |
| # | Thumb | 标题 | 描述 | 时长 | 转场 | 速度 | 素材 | AI | …                    |
|----------------------------------------------------------------------------------|
| 1 |  []   | 开场 | …    | 1.5s | Fade | 1.0 | clip1 | ⋮ |                       |
| 2 |  []   | …    | …    | 2.0s | None | 1.0 | clip2 | ⋮ |                       |
|----------------------------------------------------------------------------------|
| 抽屉（选中某行时展开，编辑该分镜详细参数 + 字幕 AI）                              |
| [分镜参数] 入点/出点/时长、转场(含持续/方向/遮罩)、速度、适配、素材替换/重检索    |
| [字幕(本段覆盖)] 启用/禁用、时移(±秒)、位置(bottom/top/center/custom%)、字号…     |
| [AI 字幕] 对齐脚本/润色/翻译/简化/风格、关键词高亮、智能断句                      |
| [AI 文案] 生成/改写镜头描述、检索词/风格词建议、转场建议                          |
+----------------------------------------------------------------------------------+
| 右侧“全局参数”（折叠）：字体/描边/全局字幕偏移、BGM音量/淡入淡出/ducking…        |
+----------------------------------------------------------------------------------+
```

## 关键交互
- 选中联动：时间线与列表互相高亮；点击空白清空选择。
- 自动保存：行内编辑 onBlur 或节流（如 3 秒）自动保存；提供“已保存”提示与撤销/重做。
- 批量操作：多选段落，统一修改时长/速度/转场/字幕偏移；支持“AI 批量建议”。
- 预览策略：
  - 预览（前 N 段/当前选择）：仅输出合成画面（无字幕/配音/BGM 混流），保证快速反馈。
  - 全量渲染：叠加音频与字幕，输出成片链接。
- 键盘：↑↓切行，←→移动焦点；Delete 删除；Cmd/Ctrl+A 全选；Shift 点击连续选择。

## 分镜级字幕设计

### v1：参数级（快速落地）
- 目的：允许在“该分镜时间窗内”的字幕做时移（offset）与样式覆盖（position/font/size/color/stroke/bg）。
- 后端数据（新增字段）：
  - `SegmentItem.subtitle_offset: Optional[float]`
  - `SegmentItem.subtitle_style: Optional[dict]`（或细分字段，如 `subtitle_position`, `font_size`, `text_fore_color` 等）
- 渲染逻辑：
  - 加载全局 SRT；遍历字幕条目，凡时间落在 `[seg.start, seg.end]` 的条目：
    - 应用 `subtitle_offset`（可正/负）
    - 生成 TextClip 时以该段的 `subtitle_style` 覆盖全局样式
  - 窗口外条目按全局样式渲染。
- 前端 UI：
  - 抽屉“字幕(本段覆盖)”中提供启用/禁用、时移(±秒)、位置(top/bottom/center/custom%)、字号、颜色、描边/背景等。
  - 批量操作支持统一时移和样式覆盖。

### v2：内容级（AI 重写）
- 目的：对某分镜时间窗内的字幕文本做 AI 级改写（润色/翻译/简化/风格化/关键词高亮），不改变音频。
- 新增 API（草案）：`POST /v1/subtitles/rewrite`
  - 入参：`task_id`, `segment_id`, `mode`, `options`
  - 处理：读取该窗字幕片段 → 调用 LLM 重写 → 写入该段覆盖 SRT/ASS（按段落版本管理）
  - 渲染：该窗以覆盖文件优先。
- UI：抽屉“AI 字幕”提供模式选择与一键应用；支持对比/还原。

## 数据模型与接口变更（最小集）
- Backend 模型（`app/models/schema.py`）：
  - `SegmentItem` 新增：
    - `subtitle_offset: Optional[float] = None`
    - `subtitle_style: Optional[dict] = None`（或细分字段）
- Frontend 类型（`web/lib/schemas.ts`）：同步上述字段。
- 保存（`POST /v1/segments/save`）：兼容携带新字段；后端落盘至 `segments.json`。
- 渲染（`POST /v1/segments/render`）：
  - 继续允许传 `params`（全局默认）；
  - 渲染端读取每段 `subtitle_*` 覆盖并按时间窗筛选 SRT 条目。

## 迭代计划

### M1（1–2 天）：统一视图 + 分镜级字幕时移
- 交付：
  - 新组件 `SequenceEditor`（融合现有时间线与列表，保留现有能力）。
  - 行内/抽屉编辑 + 自动保存 + 批量选择框架。
  - `subtitle_offset` 字段贯通 UI→API→渲染（每段生效）。
- 验收：
  - 选中段落在两视图互相高亮；行内改时长/速度/转场可保存与还原；
  - 指定某段 `subtitle_offset` 后，全量渲染字幕时间仅该段发生偏移。

### M2（2–4 天）：AI 字幕 v1 + 批量操作 + 模板
- 交付：
  - “AI 字幕（对齐/润色/翻译/简化）”对整段文本生成建议（不改音频）；
  - 批量操作（时长/转场/字幕偏移）与“AI 批量建议”；
  - 参数模板保存/应用。
- 验收：
  - 能对单段应用 AI 字幕建议；
  - 批量选择段落统一修改并可撤销。

### M3（>1 周）：AI 字幕 v2 + AI 转场建议 + 节奏匹配
- 交付：
  - `subtitles/rewrite` 覆盖文件与版本化；
  - 基于语义与节奏的转场/持续/方向建议；
  - 按语音拍点或语速的“节奏匹配”自动切分建议。
- 验收：
  - 覆盖文件生效并可回滚；
  - 一键采纳转场/节奏建议后，预览/成片表现稳定。

## 兼容性与风险
- SRT 与分镜时间窗边界对齐：需处理条目跨窗、偏移后越界的裁剪与保护（最小间隔 0.1s）。
- 性能：字幕 TextClip 数量上升时需控制样式切换与缓存（可按段聚合）。
- 预览与全量差异：预览不含字幕与音频，属于刻意取舍；通过成片链接校核字幕。
- 回退：落盘 `segments.json` 并提供撤销/重做；字幕覆盖文件版本化存储。

## 开放问题（待确认）
1. `subtitle_style` 作为字典还是拆分具体字段（position/font/size/color/stroke/bg）？倾向拆分，便于校验与前后端类型一致。
2. 是否需要“分镜级禁用字幕”布尔开关（仅该段不显示字幕）？
3. 批量 AI 字幕建议的策略（按关键词/按段落类型/按位置）与预算限制？
4. 时间线缩略图生成的频率与缓存策略是否需要提升（当前生成于后台）。

## 执行与回滚
- 实施前：以本方案创建任务卡与 PR 草案，评审通过后开发。
- 回滚：保留现有 Shotlist Editor 与 Timeline 代码路径；`SequenceEditor` 挂载为新视图，必要时可快速切换回旧视图。

---

若确认本方案（方案 A），请授权开始 M1 开发：
- 新建 `SequenceEditor` 组件（混合视图）；
- `SegmentItem` 新增 `subtitle_offset` 字段（UI→API→渲染全流程）；
- 自动保存与撤销/重做最小实现；
- 文档与使用说明更新。

待授权后开始实施，期间保持小步提交与可回滚性。

## 实施进展（更新日志）

- 2025-09-11（M1-1）：
  - 新增前端 `SequenceEditor` 组件骨架（混合视图：时间线 + 列表只读）。
  - 已集成至任务详情页为新 Tab“序列”，复用现有时间线能力，列表用于信息对齐与后续抽屉扩展的占位。
  - 暂未修改后端与渲染逻辑；下一步将补充“分镜级字幕时移（subtitle_offset）”的前端抽屉编辑与后端字段对齐，随后串联保存与渲染。

- 2025-09-11（M1-2）：分镜级字幕时移贯通（v1）
  - 后端模型：`app/models/schema.py` 的 `SegmentItem` 增加 `subtitle_offset?: float`。
  - 渲染：`app/services/video.py::generate_video()` 接受可选 `segments`，在合成后按分镜时间窗应用 per-segment `subtitle_offset`（与全局 `params.subtitle_offset` 可叠加），并做时间裁剪保护（最小时长 0.1s）。
  - API 串联：`render_from_segments()` 在全量渲染时传入 `segments`，预览仍不叠加字幕（与策略一致）。
  - 前端 UI：`web/components/sequence/sequence-editor.tsx` 列表新增“字幕时移(秒)”可编辑列，支持保存到 `/v1/segments/save`。

- 2025-09-11（M1-3）：分镜级字幕样式覆盖 + 抽屉编辑（v1）
  - 后端模型：`SegmentItem` 新增可选样式覆盖字段（全部可为 `null` 表示继承）：
    - `subtitle_enabled?: bool`（`false`=仅该段隐藏字幕）、`subtitle_position?: 'bottom'|'top'|'center'|'custom'`、`custom_position?: number(%)`；
    - `font_name?: string`、`font_size?: number`、`text_fore_color?: string`、`stroke_color?: string`、`stroke_width?: number`、`text_background_color?: bool|string`。
  - 渲染：在 `generate_video()` 中对每条字幕计算其落在哪个分镜时间窗，合并全局参数与本段覆盖，逐条构造 TextClip；若该段 `subtitle_enabled=false` 则跳过该窗字幕。
  - 前端 UI：
    - 序列列表新增“编辑”打开抽屉，支持设置本段覆盖（位置/字号/颜色/描边/背景/禁用）；“空值=继承”。
    - 支持多选并“将抽屉覆盖批量应用”；统一保存沿用“保存字幕时移”按钮（保存整个 segments）。

- 2025-09-11（M2-1）：AI 字幕 v1 建议（不改音频/不写文件）
  - 后端 API：新增 `POST /v1/subtitles/suggest`，入参 `{ task_id, segment_id|order, mode(polish|simplify|translate-zh|translate-en) }`；
    - 逻辑：读取 `segments.json` → 计算该段合成时间窗 → 读取 `subtitle.srt` → 收集落窗字幕合并为原文 → 调用 LLM 生成建议 → 返回 `{ original_text, suggestion }`。
  - 前端 UI：序列编辑器抽屉新增“AI 字幕建议”区块：选择模式后“生成建议”，展示原文与建议并支持复制；提供“为已选生成建议”的批量入口（逐段生成、缓存）。
  - 注：v1 仅输出建议文本，不改变渲染；v2 将提供“覆盖 SRT/ASS”与应用/对比/回滚。

- 2025-09-11（M2-2）：AI 字幕 v2 覆盖 + 应用/回滚
  - 后端 API：
    - `POST /v1/subtitles/rewrite`：按分镜时间窗生成覆盖 SRT（相对窗的时间），版本化保存到 `tasks/<id>/sub_overrides/<segment_id>/vNNN.srt`；`apply=true` 则复制为 `applied.srt`；支持传入 `suggestion` 直接应用，未传则自动 LLM 生成。
    - `GET /v1/subtitles/overrides?task_id&segment_id`：列出已有版本与当前应用。
    - `POST /v1/subtitles/apply?task_id&segment_id&version`：将指定版本应用为 `applied.srt`。
    - `POST /v1/subtitles/revert?task_id&segment_id`：取消应用（删除 `applied.srt`）。
  - 渲染：`generate_video()` 检测每个分镜是否存在 `applied.srt`，若有则跳过该窗内原始 SRT 条目，加载覆盖 SRT（相对时间 + 窗口起点 + 全局/分镜时移），并按本段样式/全局样式渲染；窗口外仍用原始 SRT。
  - 前端 UI：抽屉中“AI 字幕建议”新增按钮：`应用为覆盖(v2)`、`回滚覆盖`。应用后需“全量渲染”查看效果；后续可扩展“历史版本选择/对比”。
