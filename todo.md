**前端重构 Roadmap (TODO)**

- 范围：引入 Next.js + shadcn‑ui + Tailwind CSS v4 构建全新前端，继续复用当前 FastAPI 后端与渲染管线；Streamlit 保留为“调试/运营台”。
- 版本：P0（前端骨架与关键流程）、P1（可视化编辑器加强）、P2（品牌化/项目化/运维）。Backlog 收录可选扩展。

**全局原则**
- [x] 继续使用既有 `/v1/*` API，不破坏 `/v1/videos` 默认流程。
- [x] 前端状态使用 `@tanstack/react-query` 管理请求、`zustand` 管理跨页 UI 状态，强约束类型（`zod`/TS interface）。
- [ ] 统一任务目录约定与 `segments.json` 持久化，保证可重现渲染。
- [ ] 先通后优：优先走通“计划 → 编辑 → 预览/成片”的关键链路，再精致交互。

**P0 — 新前端骨架与关键链路（1–2 周）**
- [x] 选型与结构
  - [x] 目录确定：`web/` 作为 Next.js 应用根目录（避免与 `webui/` 冲突）。
  - [x] 创建 Next.js（App Router + TS）工程，接入 Tailwind v4 与 PostCSS 配置。
  - [x] 安装并初始化 shadcn‑ui（components.json、Tailwind tokens、Toaster）。
  - [x] 依赖安装并本地可跑（pnpm 安装完成，开发环境可启动）。
- [ ] 基础设施
  - [x] 环境变量与 API 基址：支持 `NEXT_PUBLIC_API_BASE`，本地/生产区分。
  - [x] 请求封装：`lib/api.ts`（fetch 基础、错误统一、重试策略）。
  - [x] 类型/Schema：为核心接口建 `zod` schema（segments 相关、任务相关）。
  - [x] 全局 UI：Toaster、Dialog、Loading/Empty/Skeleton 组件。
- [ ] 核心页面与导航
  - [x] 布局：侧边导航（任务、创建、设置）、顶部工具条、面包屑。
  - [x] 任务列表页：解析包装响应 `/v1/tasks`，展示进度/产物链接，支持分页。
  - [x] 新建任务向导（最小）：主题/画幅/拼接/单段时长/来源 → 调用 `/v1/videos` 或 `segments/plan`，成功后跳转任务详情。
  - [x] 任务详情页：解析包装响应 `/v1/tasks/{id}`，展示进度与产物链接，接入时间线（MVP）。
- [ ] 时间线（MVP）
  - [x] 段列表（竖排即可）：显示基础信息/时长/转场，支持上移/下移。
  - [x] 段参数编辑：时长、转场下拉、速度。
  - [x] 预览与渲染按钮：调用 `POST /v1/segments/render`，支持前 N 段预览与全量渲染。
  - [x] 删除/恢复：支持删除单段与恢复最近删除；支持批量删除所选。
  - [x] 批量编辑：对已选段批量设置时长/速度/转场。
  - [x] 错误高亮与约束：时长>0；速度 0.5–2.0；存在错误时禁用渲染并提示。
  - [x] 预览进度与轮询：详情页轮询 `/v1/tasks/{id}`，展示进度条；处理中禁用渲染按钮。
  - [x] 渲染交互优化：渲染中局部 Loading 文案与按钮内 Spinner；渲染时禁用相关控件并提示。
  - [x] 持久化编辑：新增 `/v1/segments/save`，前端“保存分镜”将当前顺序与参数写回 `segments.json`。
- [ ] shadcn‑ui 组件包（按需引入）
  - [x] Button / Input / Textarea / Dialog / Skeleton 基础接入。
  - [x] Select 统一替换原生下拉（创建页、时间线转场/批量转场）。
  - [x] 后续：Tabs / Tooltip / Toast（保留 Sonner）/ Progress / DropdownMenu / Slider 已接入。
- [ ] 接入与验收
  - [x] 端到端：主题 → 生成分镜 → 简单排序与编辑 → 预览前 3 段 → 全量渲染。
  - [x] 错误体验：API 失败提示与取消中断（创建/渲染支持 Abort，UI 明确 Loading 与禁用）。
  - [x] 文档：README 前端启动、环境变量、与后端联调说明。

**P1 — 可视化编辑与素材管理（2–4 周）**
- [ ] 时间线可视化与交互
  - [x] 使用 dnd‑kit 横向时间线，拖拽排序与选中高亮。
  - [x] 多选/批量操作（批量调整转场/时长）。
  - [x] 片段缩略图与时码标尺，关键操作快捷键。
- [ ] 片段深度编辑
  - [x] 入点/出点数值编辑与拖拽修剪，时长与音频总长校验。
  - [x] 速度（0.75–1.25x）、填充模式（contain/cover/center）设置。
  - [x] 转场库与参数（淡入淡出/推拉/遮罩）。
 - [ ] 素材检索与替换
  - [x] 源选择：本地上传/已有素材库/第三方（Pexels/Pixabay，本地代理）。
    - 新增后端接口：`GET /v1/materials`、`POST /v1/materials`、`GET /v1/materials/search`、`POST /v1/materials/download`
    - 前端实现 MaterialPicker（三来源 Tab）：素材库/上传/在线检索，时间线“替换素材”已接入
  - [x] 分镜级替换与预览；“对单段重检索”操作。
    - [x] 时间线每段：单段预览按钮（仅渲染该段）
    - [x] 重检索：打开在线检索（预填 shot_desc/scene_title），选择后替换并自动预览
    - [x] 预览隔离：服务端支持 `preview=true`，写入 `preview-<segment_id>.mp4`，不覆盖成片
    - [x] 检索体验：返回缩略图（Pexels）、前端展示图文卡片；素材库支持客户端筛选
- [ ] 字幕与音频体验
  - [x] 字幕模板（字号/描边/阴影/位置）与整片时移。
  - [x] BGM ducking 与淡入淡出开关。
- [ ] 稳定性
  - [x] 预览缓存与并发限制；进度/队列显示；失败重试与回退。

**P2 — 品牌化、项目化与运维（4–6 周）**
- [ ] 品牌与输出预设
  - [ ] 品牌模板：片头/片尾/水印/Logo/色卡/字体。
  - [ ] 输出预设：1080×1920、1920×1080、1:1，码率/平台兼容。
- [ ] 项目与协作
  - [ ] 项目页：版本历史/回滚/参数快照；草稿分享（只读链接）。
  - [ ] 简易鉴权与配额（token 或 basic key），并发上限配置。
- [ ] 可观测性与稳定性
  - [ ] 指标：任务用时/失败率/渲染阶段耗时；错误归因（素材/字幕/编码）。
  - [ ] 清理策略：临时文件与 clips 回收，磁盘与内存水位监测。

**Backlog（可选）**
- [ ] LLM 扩展：`generate_shotlist`、`generate_brief`、`generate_terms_per_shot`；多语言与翻译。
- [ ] 高级转场/效果包；镜头运动/景别建议自动化。
- [ ] 自动节拍（BPM）驱动切片；台词‑分镜句级/词级对齐。
- [ ] 云端渲染与异步队列；计费（按分钟/次数）。
- [ ] PWA/离线能力与上传断点续传。

**迁移策略**
- [x] 在 `web/` 新建 Next.js 工程，保留 `webui/` 供内部调试；中短期双栈并存。
- [x] 新前端优先覆盖“分镜→编辑→预览/成片”，其余设置留在 Streamlit。
- [x] 新旧 UI 共用同一任务与文件结构，避免数据割裂。

**已完成的补充项（P0 内增强）**
- [x] 列表页使用 react-query：分页缓存、相邻页预取、10s 轮询、删除/重试（乐观更新）。
- [x] 详情页操作补齐：删除/重试，联动全局 Busy 指示与缓存失效。
- [x] 创建页 zod 校验与缓存联动：错误集中提示，创建成功后失效列表并预取详情。

**依赖与风险**
- [ ] MoviePy/ffmpeg 性能：继续采用分段烘焙+渐进合并，控制 fps/threads。
- [ ] 第三方素材限流：本地缓存与多 Key 轮换；失败重试与降级占位。
- [ ] Tailwind v4 变更：样式约定与 tokens 明确，避免自定义过深。
- [ ] 浏览器端大文件处理：上传分片/并发/取消支持。

**验收清单（每版本）**
- [ ] 端到端冒烟：主题 → 分镜 → 排序/编辑 → 预览 → 成片。
- [ ] 任务状态清晰：可见进度、可重试、可取消，产物可下载播放。
- [ ] 错误可复现：日志包含阶段与关键上下文。
- [ ] 文档更新：环境变量、开发/联调手册、常见问题。

**工程规范**
- [ ] 代码生成与脚手架：统一 `pnpm`/`turbo`（可选），组件/页面模板。
- [ ] API 层强类型与单测（schema parse + 典型失败分支）。
- [ ] UI 基础组件从 shadcn 统一导出，避免重复样式。
- [ ] 不在本阶段改动后端架构；仅补充必要接口与文档。
